
@{
    ViewBag.Title = "Index";
}

<script src="~/Scripts/jquery.signalR-2.4.3.min.js"></script>
<script src="~/signalr/hubs"></script>

@{
    var name = Guid.NewGuid().ToString();
}

@(Html.Kendo().Chat()
    .Name("chat")
    .AuthorId(@name)
    .IsTypingField("isTyping")
    .FileAttachment(false)
    .Events(events => events
        .Input("onInput")
        .SendMessage("onSendMessage")
    )
)

<script>
    const currentUser = {
        id: '@name',
        name: 'User123',
        iconUrl: "https://demos.telerik.com/kendo-ui/content/chat/avatar.png"
    };
    var isTyping = false;
    var chatHub;

    $(function () {
        chatHub = $.connection.chatHub;

        chatHub.client.broadcastMessage = function (senderId, senderName, message) {
            const chat = $("#chat").getKendoChat();

            // Check for a "typing" message.
            let typingMessages = $.grep(chat.dataSource.data(), function (item) {
                return item.isTyping == true ? item.id : "";
            });

            if (typingMessages.length > 0) {
                if (typingMessages[0].id != null) {
                    let messageObject = chat.dataSource.get(typingMessages[0].id);
                    if (messageObject) {
                        // Update the "typing" message with the received message text.
                        let updatedMessage = chat.updateMessage(messageObject, {
                            text: message,
                            isTyping: false
                        });
                    }
                }
            } else {
                // Post the received message in the Chat.
                chat.postMessage({
                    id: kendo.guid(),
                    authorId: senderId,
                    authorName: senderId,
                    authorImageUrl: currentUser.iconUrl,
                    text: message,
                    isTyping: false
                });
            }
        };

        chatHub.client.typing = function (senderId, senderName) {
            console.log(senderName + ' is typing');
            const chat = $("#chat").getKendoChat();

            chat.postMessage({
                id: kendo.guid(),
                isTyping: true,
                authorId: senderId,
                authorName: senderId,
                authorImageUrl: currentUser.iconUrl
            });
        };

        // Start the connection.
        $.connection.hub.start().done(function () {
            console.log('SignalR connection started.');
        }).fail(function (err) {
            console.error('Error starting SignalR connection: ' + err.toString());
        });
    });

    // The 'Input' will notify the SignallR Hub that the current client is typing.
    // The Hub, in turn, will notify all the other clients that the user has started typing.
    function onInput(e) {
        // If not already typing, send typing notification.
        if (!isTyping) {
            isTyping = true;
            chatHub.server.sendTyping(currentUser.id, currentUser.name);
        }
    }

    // The 'SendMessage' handler will send the user data and the typed text to the SignalR Hub.
    // The Hub will then forward that info to the other clients.
    function onSendMessage(args) {
        // Update the message data based on the current user's data.
        args.message.id = kendo.guid();
        args.message.authorId = currentUser.id;
        args.message.authorName = currentUser.name;
        args.message.authorImageUrl = currentUser.iconUrl;

        // Stop typing when sending a message.
        if (isTyping) {
            isTyping = false;
        }
        chatHub.server.send(args.message.authorId, args.message.authorName, args.message.text);
    }
</script>
