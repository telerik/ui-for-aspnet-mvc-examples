/*
* Kendo UI Complete v2012.2.710 (http://kendoui.com)
* Copyright 2012 Telerik AD. All rights reserved.
*
* Kendo UI Complete commercial licenses may be obtained at http://kendoui.com/complete-license
* If you do not own a commercial license, this file shall be governed by the trial license terms.
*/
;(function(a,b){function j(a){return a.position().top+3}var c=window.kendo,d=c.ui.Widget,e=a.proxy,f=c.template('<div class="k-group-indicator" data-#=data.ns#field="${data.field}" data-#=data.ns#title="${data.title || ""}" data-#=data.ns#dir="${data.dir || "asc"}"><a href="\\#" class="k-link"><span class="k-icon k-si-arrow-${(data.dir || "asc") == "asc" ? "n" : "s"}">(sorted ${(data.dir || "asc") == "asc" ? "ascending": "descending"})</span>${data.title ? data.title: data.field}</a><a class="k-button k-button-icon k-button-bare"><span class="k-icon k-group-delete"></span></a></div>',{useWithBlock:!1}),g=function(b){return a('<div class="k-header k-drag-clue" />').css({width:b.width(),paddingLeft:b.css("paddingLeft"),paddingRight:b.css("paddingRight"),lineHeight:b.height()+"px",paddingTop:b.css("paddingTop"),paddingBottom:b.css("paddingBottom")}).html(b.attr(c.attr("title"))||b.attr(c.attr("field"))).prepend('<span class="k-icon k-drag-status k-denied" />')},h=a('<div class="k-grouping-dropclue"/>'),i=/(\[|\]|\$|\.|\:|\+)/g,k=d.extend({init:function(b,f){var i=this,k,l=c.guid(),m=e(i._intializePositions,i),n,o=i._dropCuePositions=[];d.fn.init.call(i,b,f),n=i.options.draggable||new c.ui.Draggable(i.element,{filter:i.options.filter,hint:g,group:l}),k=i.groupContainer=a(i.options.groupContainer,i.element).kendoDropTarget({group:n.options.group,dragenter:function(a){i._canDrag(a.draggable.currentTarget)&&(a.draggable.hint.find(".k-drag-status").removeClass("k-denied").addClass("k-add"),h.css({top:j(k),left:0}).appendTo(k))},dragleave:function(a){a.draggable.hint.find(".k-drag-status").removeClass("k-add").addClass("k-denied"),h.remove()},drop:function(b){var d=b.draggable.currentTarget,e=d.attr(c.attr("field")),f=d.attr(c.attr("title")),g=i.indicator(e),j=i._dropCuePositions,k=j[j.length-1],l;if(!!d.hasClass("k-group-indicator")||!!i._canDrag(d))k?(l=i._dropCuePosition(h.offset().left+parseInt(k.element.css("marginLeft"),10)+parseInt(k.element.css("marginRight"),10)),l&&i._canDrop(a(g),l.element,l.left)&&(l.before?l.element.before(g||i.buildIndicator(e,f)):l.element.after(g||i.buildIndicator(e,f)),i._change())):(i.groupContainer.append(i.buildIndicator(e,f)),i._change())}}).kendoDraggable({filter:"div.k-group-indicator",hint:g,group:n.options.group,dragcancel:e(i._dragCancel,i),dragstart:function(a){var b=a.currentTarget,c=parseInt(b.css("marginLeft"),10),d=b.position().left-c;m(),h.css({top:j(k),left:d}).appendTo(k),this.hint.find(".k-drag-status").removeClass("k-denied").addClass("k-add")},dragend:function(){i._dragEnd(this)},drag:e(i._drag,i)}).delegate(".k-button","click",function(b){b.preventDefault(),i._removeIndicator(a(this).parent())}).delegate(".k-link","click",function(b){var d=a(this).parent(),e=i.buildIndicator(d.attr(c.attr("field")),d.attr(c.attr("title")),d.attr(c.attr("dir"))=="asc"?"desc":"asc");d.before(e).remove(),i._change(),b.preventDefault()}),n.bind(["dragend","dragcancel","dragstart","drag"],{dragend:function(){i._dragEnd(this)},dragcancel:e(i._dragCancel,i),dragstart:function(a){var b,c,d;!i.options.allowDrag&&!i._canDrag(a.currentTarget)?a.preventDefault():(m(),o.length?(b=o[o.length-1].element,c=parseInt(b.css("marginRight"),10),d=b.position().left+b.outerWidth()+c):d=0)},drag:e(i._drag,i)}),i.dataSource=i.options.dataSource,i.dataSource&&(i._refreshHandler=e(i.refresh,i),i.dataSource.bind("change",i._refreshHandler))},refresh:function(){var b=this,d=b.dataSource;b.groupContainer.empty().append(a.map(d.group()||[],function(a){var d=a.field.replace(i,"\\$1"),e=b.element.find(b.options.filter).filter("["+c.attr("field")+"="+d+"]");return b.buildIndicator(a.field,e.attr(c.attr("title")),a.dir)}).join("")),b._invalidateGroupContainer()},destroy:function(){var a=this;a.dataSource&&a._refreshHandler&&a.dataSource.unbind("change",a._refreshHandler)},options:{name:"Groupable",filter:"th",messages:{empty:"Drag a column header and drop it here to group by that column"}},indicator:function(b){var d=a(".k-group-indicator",this.groupContainer);return a.grep(d,function(d){return a(d).attr(c.attr("field"))===b})[0]},buildIndicator:function(a,b,d){return f({field:a,dir:d,title:b,ns:c.ns})},descriptors:function(){var b=this,d=a(".k-group-indicator",b.groupContainer),e,f,g,h,i;e=b.element.find(b.options.filter).map(function(){var b=a(this),d=b.attr(c.attr("aggregates")),e=b.attr(c.attr("field"));if(d&&d!==""){f=d.split(","),d=[];for(h=0,i=f.length;h<i;h++)d.push({field:e,aggregate:f[h]})}return d}).toArray();return a.map(d,function(b){b=a(b),g=b.attr(c.attr("field"));return{field:g,dir:b.attr(c.attr("dir")),aggregates:e||[]}})},_removeIndicator:function(a){var b=this;a.remove(),b._invalidateGroupContainer(),b._change()},_change:function(){var a=this;a.dataSource&&a.dataSource.group(a.descriptors())},_dropCuePosition:function(b){var c=this._dropCuePositions;if(!!h.is(":visible")&&c.length!==0){b=Math.ceil(b);var d=c[c.length-1],e=d.right,f=parseInt(d.element.css("marginLeft"),10),g=parseInt(d.element.css("marginRight"),10);b>=e?b={left:d.element.position().left+d.element.outerWidth()+g,element:d.element,before:!1}:(b=a.grep(c,function(a){return a.left<=b&&b<=a.right})[0],b&&(b={left:b.element.position().left-f,element:b.element,before:!0}));return b}},_drag:function(a){var b=c.touchLocation(a),d=this._dropCuePosition(b.x);d&&h.css({left:d.left})},_canDrag:function(a){return a.attr(c.attr("groupable"))!="false"&&(a.hasClass("k-group-indicator")||!this.indicator(a.attr(c.attr("field"))))},_canDrop:function(a,b,c){var d=a.next();return a[0]!==b[0]&&(!d[0]||b[0]!==d[0]||c>d.position().left)},_dragEnd:function(b){var d=this,e=b.currentTarget.attr(c.attr("field")),f=d.indicator(e);b!==d.options.draggable&&!b.dropped&&f&&d._removeIndicator(a(f)),d._dragCancel()},_dragCancel:function(){h.remove(),this._dropCuePositions=[]},_intializePositions:function(){var b=this,c=a(".k-group-indicator",b.groupContainer),d;b._dropCuePositions=a.map(c,function(b){b=a(b),d=b.offset().left;return{left:parseInt(d,10),right:parseInt(d+b.outerWidth(),10),element:b}})},_invalidateGroupContainer:function(){var a=this.groupContainer;a.is(":empty")&&a.html(this.options.messages.empty)}});c.ui.plugin(k)})(jQuery);